<oui-header data-heading="{{:: 'pci_database_add_title' | translate }}">
    <oui-guide-menu data-text="{{:: 'pci_project_guides_header' | translate }}">
        <oui-guide-menu-item href="{{ $ctrl.guideUrl }}" data-external>
            <span data-translate="pci_project_guides_header_all_guides"></span>
        </oui-guide-menu-item>
        <oui-guide-menu-item href="{{ $ctrl.databaseGuideUrl }}" data-external>
            <span data-translate="pci_database_list_title"></span>
        </oui-guide-menu-item>
    </oui-guide-menu>
</oui-header>

<div class="mt-4" id="addMessages">
    <cui-message-container
        data-messages="$ctrl.messages"
    ></cui-message-container>
</div>

<p>
    <span data-translate="pci_database_add_description1"></span>
    <a
        data-ng-href="{{:: $ctrl.addPrivateNetworksLink }}"
        data-translate="pci_database_add_description2"
        data-ng-click="$ctrl.trackDatabases('top_create_private_network')"
        rel="noopener"
        target="_top"
    ></a>
    <span data-translate="pci_database_add_description3"></span>
</p>
<div class="row">
    <div class="col-lg-8">
        <form novalidate>
            <!-- Step 1 -->
            <h2 id="engine">
                {{:: 'pci_database_add_step1_title' | translate }}
            </h2>
            <p>{{:: 'pci_database_add_step1_description' | translate }}</p>
            <database-engines-list
                data-engines="$ctrl.engines"
                data-selected-engine="$ctrl.model.engine"
                on-change="$ctrl.onEngineChanged(selectedEngine)"
            ></database-engines-list>

            <!-- Step 2 -->
            <h2 id="plan">
                {{:: 'pci_database_add_step2_title' | translate }}
            </h2>
            <database-plans-list
                data-plans="$ctrl.model.engine.selectedVersion.plans"
                data-selected-plan="$ctrl.model.plan"
                data-user="$ctrl.user"
                on-change="$ctrl.onPlanChanged(selectedPlan)"
            ></database-plans-list>

            <!-- Step 3 -->
            <h2 id="region">
                {{:: 'pci_database_add_step3_title' | translate }}
            </h2>
            <pci-project-regions-list
                data-regions="$ctrl.model.plan.regions"
                data-selected-region="$ctrl.model.region"
                on-change="$ctrl.onRegionChanged(region)"
            ></pci-project-regions-list>

            <!-- Step 4 -->
            <h2 id="flavor">
                {{:: 'pci_database_add_step4_title' | translate }}
            </h2>
            <oui-field
                data-label="{{ ::'pci_database_add_nodes_count' | translate }}"
            >
                <oui-numeric
                    data-disabled="true"
                    data-name="nodesCount"
                    data-model="$ctrl.model.plan.nodesCount"
                    data-min="$ctrl.model.plan.minNodes"
                    data-max="$ctrl.model.plan.maxNodes"
                >
                </oui-numeric>
            </oui-field>
            <p data-translate="pci_database_add_select_flavor"></p>
            <database-flavors-list
                data-flavors="$ctrl.model.region.flavors"
                data-selected-flavor="$ctrl.model.flavor"
                data-user="$ctrl.user"
                on-change="$ctrl.onFlavorChanged(selectedFlavor)"
            ></database-flavors-list>

            <!-- Step 5 -->
            <h2 id="network">
                {{:: 'pci_database_add_step5_title' | translate }}
            </h2>
            <oui-message
                data-ng-if="!($ctrl.model.flavor.supportsPublicNetwork && $ctrl.model.flavor.supportsPrivateNetwork)"
                data-type="info"
            >
                <span
                    data-ng-bind="(
                        $ctrl.model.flavor.supportsPublicNetwork
                            ? 'pci_database_add_network_mode_private_incompatible'
                            : 'pci_database_add_network_mode_public_incompatible'
                        ) | translate"
                ></span>
            </oui-message>

            <oui-field
                data-label="{{ :: 'pci_database_add_network_mode_label' | translate }}"
            >
                <oui-radio-group
                    data-model="$ctrl.model.usePrivateNetwork"
                    data-on-change="$ctrl.onNetworkTypeChange(modelValue)"
                >
                    <oui-radio
                        data-value="false"
                        data-disabled="$ctrl.loadingSubnets || !$ctrl.model.flavor.supportsPublicNetwork"
                    >
                        <span
                            data-translate="pci_database_add_network_mode_public"
                        ></span>
                    </oui-radio>
                    <oui-radio
                        data-value="true"
                        data-disabled="$ctrl.loadingSubnets || !$ctrl.model.flavor.supportsPrivateNetwork"
                    >
                        <span
                            data-translate="pci_database_add_network_mode_private"
                        ></span>
                    </oui-radio>
                </oui-radio-group>
            </oui-field>

            <div data-ng-if="$ctrl.model.usePrivateNetwork">
                <oui-field
                    data-label="{{:: 'pci_database_add_privateNetwork_label' | translate }}"
                    data-size="l"
                >
                    <oui-select
                        data-name="privateNetwork"
                        data-model="$ctrl.model.privateNetwork"
                        data-items="$ctrl.availablePrivateNetworks"
                        data-ng-if="$ctrl.availablePrivateNetworks.length > 1"
                        data-match="name"
                        data-disabled="$ctrl.loadingSubnets"
                        data-searchable
                        data-on-change="$ctrl.onPrivateNetworkChange(modelValue)"
                    >
                    </oui-select>
                    <p>
                        <span
                            data-translate="pci_database_add_privateNetwork_description"
                        ></span>
                        <a
                            data-ng-href="{{:: $ctrl.addPrivateNetworksLink }}"
                            data-translate="pci_database_add_privateNetwork_add"
                            data-ng-click="$ctrl.trackDatabases('config_create_private_network')"
                            rel="noopener"
                            target="_top"
                        ></a>
                    </p>
                </oui-field>

                <div data-ng-if="$ctrl.model.privateNetwork.id">
                    <div data-ng-if="$ctrl.loadingSubnets">
                        <oui-spinner data-size="s"></oui-spinner>
                        <span
                            data-translate="pci_database_add_subnet_loading"
                        ></span>
                    </div>
                    <oui-field
                        data-ng-if="!$ctrl.loadingSubnets"
                        data-label="{{:: 'pci_database_add_subnet_label' | translate }}"
                        data-size="l"
                    >
                        <input
                            type="hidden"
                            aria-hidden="true"
                            data-ng-if="!$ctrl.availableSubnets || $ctrl.availableSubnets.length <= 1"
                        />
                        <oui-select
                            data-name="subnet"
                            data-model="$ctrl.model.subnet"
                            data-items="$ctrl.availableSubnets"
                            data-ng-if="$ctrl.availableSubnets.length > 1"
                            data-match="name"
                            data-searchable
                            data-on-change="$ctrl.prepareOrderData()"
                        >
                        </oui-select>
                        <p>
                            <span
                                data-translate="pci_database_add_subnet_description"
                            ></span>
                            <a
                                data-ng-href="{{:: $ctrl.addPrivateNetworksLink }}"
                                data-translate="pci_database_add_subnet_add"
                                data-ng-click="$ctrl.trackDatabases('config_create_subnet')"
                                rel="noopener"
                                data-on-change="$ctrl.prepareOrderData()"
                            ></a>
                        </p>
                    </oui-field>
                </div>
            </div>

            <!-- Step 6 -->
            <h2>{{:: 'pci_database_add_step6_title' | translate }}</h2>
            <pci-order-command
                data-order-api-url="$ctrl.orderAPIUrl"
                data-order-data="$ctrl.orderData"
                data-user="$ctrl.user"
            >
                <p data-translate="pci_database_add_command_description"></p>
                <a
                    class="oui-link_icon"
                    data-ng-href="{{:: $ctrl.apiGuideUrl }}"
                    target="_blank"
                    rel="noopener"
                >
                    <span
                        data-translate="pci_database_add_command_documentation_link"
                    ></span>
                    <span
                        class="oui-icon oui-icon-external-link"
                        aria-hidden="true"
                    ></span>
                </a>
            </pci-order-command>
            <div
                class="mb-3"
                data-ng-if="$ctrl.model.engine.selectedVersion.status === 'BETA'"
            >
                <pci-project-lab-agreements
                    data-lab="$ctrl.lab"
                    data-ng-if="!$ctrl.lab.isActivated()"
                    data-on-accept="$ctrl.acceptLab(accepted)"
                    data-on-contract-click="$ctrl.clickOnContract()"
                ></pci-project-lab-agreements>
            </div>
        </form>
    </div>
    <div class="col-lg-4">
        <div class="sticky-top">
            <oui-tile data-heading="Votre commande" class="mb-3">
                <oui-tile-definition data-term="Résumé">
                    <oui-tile-description>
                        <p><b>Name:</b> {{$ctrl.model.name}}</p>
                        <div class="d-flex align-items-center">
                            <span class="mr-2"
                                ><a
                                    href=""
                                    ng-click="$ctrl.$anchorScroll('engine')"
                                    >Engine:</a
                                >
                                {{$ctrl.model.engine.getLabel()}}</span
                            >
                            <img
                                ng-src="{{$ctrl.ENGINE_LOGOS[$ctrl.model.engine.name]}}"
                                width="60px"
                                height="40px"
                                alt="engine logo"
                            />
                        </div>
                        <div class="d-flex flex-column mb-2 pl-2">
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-hashtag_concept mr-2"
                                ></span>
                                <span
                                    >Version:
                                    {{$ctrl.model.engine.selectedVersion.version}}</span
                                >
                            </span>
                        </div>
                        <p>
                            <a href="" ng-click="$ctrl.$anchorScroll('plan')"
                                >Offer:</a
                            >
                            {{$ctrl.capitalize($ctrl.model.plan.name)}}
                        </p>
                        <div class="d-flex flex-column mb-2 pl-2">
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-cloud-edge-computing_concept mr-2"
                                ></span>
                                <span
                                    data-ng-bind="$ctrl.getNodesSpecTranslation()"
                                ></span>
                            </span>
                        </div>
                        <div class="d-flex flex-column mb-2 pl-2">
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-floppy-clock_concept mr-2"
                                ></span>
                                <span
                                    >Sauvegardes manuelles et automatiques</span
                                >
                            </span>
                        </div>
                        <p>
                            <a href="" ng-click="$ctrl.$anchorScroll('region')"
                                >Region:</a
                            >
                            {{$ctrl.ovhManagerRegionService.getTranslatedMacroRegion($ctrl.model.region.name)}}
                            ({{$ctrl.model.region.name}})
                        </p>
                        <p>
                            <a href="" ng-click="$ctrl.$anchorScroll('flavor')"
                                >Flavor:</a
                            >
                            {{$ctrl.capitalize($ctrl.model.flavor.name)}}
                        </p>
                        <div class="d-flex flex-column mb-2 pl-2">
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-component_concept mr-2"
                                ></span>
                                <span>{{$ctrl.model.flavor.core}} vCores</span>
                            </span>
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-ram_concept mr-2"
                                ></span>
                                <span
                                    >{{$ctrl.model.flavor.memory|
                                    bytes:2:false:'GB'}} RAM</span
                                >
                            </span>
                            <span
                                class="d-flex"
                                ng-if="$ctrl.model.flavor.maxDiskSize > 0"
                            >
                                <span
                                    class="oui-icon oui-icon-hardware-ssd_concept mr-2"
                                ></span>
                                <span
                                    ng-if="$ctrl.model.flavor.minDiskSize === $ctrl.model.flavor.maxDiskSize"
                                    >{{$ctrl.model.flavor.minDiskSize|
                                    bytes:2:false:'GB'}} de Stockage SSD</span
                                >
                                <span
                                    ng-if="$ctrl.model.flavor.minDiskSize !== $ctrl.model.flavor.maxDiskSize"
                                    >De {{$ctrl.model.flavor.minDiskSize|
                                    bytes:2:false:'GB'}} à
                                    {{$ctrl.model.flavor.maxDiskSize|
                                    bytes:2:false:'GB'}} de Stockage SSD</span
                                >
                            </span>
                        </div>
                        <p>
                            <a href="" ng-click="$ctrl.$anchorScroll('network')"
                                >Network:</a
                            >
                            {{$ctrl.model.usePrivateNetwork ? 'private' :
                            'public'}}
                        </p>
                        <div
                            class="d-flex flex-column mb-2 pl-2"
                            ng-if="$ctrl.model.usePrivateNetwork "
                        >
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-cloud_concept mr-2"
                                ></span>
                                <span>{{$ctrl.model.privateNetwork.name}}</span>
                            </span>
                            <span class="d-flex">
                                <span
                                    class="oui-icon oui-icon-cloud-edge-computing_concept mr-2"
                                ></span>
                                <span
                                    >{{$ctrl.model.subnet.name || Aucun}}</span
                                >
                            </span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span
                                data-translate="pci_database_common_price"
                            ></span>
                            <ovh-manager-catalog-price
                                data-price="$ctrl.model.flavor.hourlyPrice.priceInUcents"
                                data-tax="$ctrl.model.flavor.hourlyPrice.tax"
                                data-user="$ctrl.user"
                                data-show-zero-price="true"
                                data-interval="'hour'"
                            >
                            </ovh-manager-catalog-price>
                        </div>
                    </oui-tile-description>
                </oui-tile-definition>
                <oui-button
                    variant="primary"
                    block
                    on-click="$ctrl.createDatabase()"
                    disabled="!$ctrl.isNetworkSelected() || $ctrl.processingOrder"
                >
                    <span ng-if="!$ctrl.processingOrder">Commander</span>
                    <div
                        data-ng-if="$ctrl.processingOrder"
                        class="d-flex justify-content-center"
                    >
                        <oui-spinner class="mr-2" data-size="s"></oui-spinner>
                        <span
                            data-translate="pci_database_add_create_database_processing"
                        ></span>
                    </div>
                </oui-button>
            </oui-tile>
        </div>
    </div>
</div>
<div class="oui-box oui-box_light">
    <p class="mt-4" data-translate="pci_database_add_footer_part_1"></p>
    <p data-translate="pci_database_add_footer_part_2"></p>
</div>
